# Multi-Agent Ralph Wiggum - Complete Architecture Diagram v2.49.1

![Version](https://img.shields.io/badge/version-2.49.1-blue)
![License](https://img.shields.io/badge/license-BSL%201.1-orange)

> "Me fail English? That's unpossible!" - Ralph Wiggum

---

## ═══════════════════════════════════════════════════════════════════════════════
##  COMPLETE WORKFLOW DIAGRAM: Context & Memory Integration v2.49.1
## ═══════════════════════════════════════════════════════════════════════════════

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          RALPH v2.49.1 COMPLETE ARCHITECTURE                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         SESSION LIFECYCLE                                 │  │
│  │                                                                          │  │
│  │   [SessionStart]                                                         │  │
│  │       │                                                                  │  │
│  │       ▼                                                                  │  │
│  │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │   │              SMART MEMORY SEARCH (PARALLEL) v2.47                │   │  │
│  │   │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │   │  │
│  │   │  │claude-mem │ │  memvid   │ │ handoffs  │ │  ledgers  │        │   │  │
│  │   │  │  (MCP)    │ │  (HNSW)   │ │ (30 days) │ │CONTINUITY │        │   │  │
│  │   │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘        │   │  │
│  │   │        │ PARALLEL    │ PARALLEL    │ PARALLEL    │ PARALLEL      │   │  │
│  │   │        └─────────────┴─────────────┴─────────────┘               │   │  │
│  │   │                            │                                      │   │  │
│  │   │                            ▼                                      │   │  │
│  │   │                   ┌─────────────────┐                             │   │  │
│  │   │                   │   MEMORY CONTEXT │                            │   │  │
│  │   │                   │  .claude/memory- │                           │   │  │
│  │   │                   │     context.json │                            │   │  │
│  │   │                   └────────┬────────┘                             │   │  │
│  │   │                            │                                      │   │  │
│  │   ▼                            ▼                                      │   │  │
│  │   ┌──────────────────────────────────────────────────────────────────┐   │  │
│  │   │                    PRETOOLUSE: TASK HOOKS                         │   │  │
│  │   │  ┌───────────────┐ ┌───────────────┐ ┌───────────────────────┐   │   │  │
│  │   │  │fast-path-check│ │smart-memory-  │ │procedural-inject      │   │   │  │
│  │   │  │     .sh       │ │search.sh      │ │.sh (learned rules)    │   │   │  │
│  │   │  └───────────────┘ └───────────────┘ └───────────────────────┘   │   │  │
│  │   └──────────────────────────────────────────────────────────────────┘   │  │
│  │                                    │                                      │   │
│  └────────────────────────────────────┼──────────────────────────────────────┘   │
│                                       │                                           │
│                                       ▼                                           │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                    ORCHESTRATOR WORKFLOW (12 Steps) v2.46                  │ │
│  │                                                                            │ │
│  │  0.EVALUATE ────► 1.CLARIFY ────► 2.CLASSIFY ────► 3.PLAN ────► 4.PLAN   │ │
│  │       │                │               │              │              MODE   │ │
│  │       │                │               │              │                │   │ │
│  │       │                │               │              │                ▼   │ │
│  │       │                │               │              │         ┌──────────┐│ │
│  │       │                │               │              │         │ Claude   ││ │
│  │       │                │               │              │         │ Code     ││ │
│  │       │                │               │              │         │Plan Mode ││ │
│  │       │                │               │              │         └──────────┘│ │
│  │       │                │               │              │                │   │ │
│  │       ▼                ▼               ▼              ▼                ▼   │ │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │ │
│  │  │                    EXECUTE-WITH-SYNC (Nested Loop)                  │   │ │
│  │  │                                                                      │   │ │
│  │  │   6a.LSA-VERIFY ──► 6b.IMPLEMENT ──► 6c.PLAN-SYNC ──► 6d.MICRO-GATE │   │ │
│  │  │        │                  │              │              │           │   │ │
│  │  │        ▼                  ▼              ▼              ▼           │   │ │
│  │  │   ┌──────────┐      ┌──────────┐  ┌──────────┐  ┌──────────┐       │   │ │
│  │  │   │ ARCHITECT│      │  Claude  │  │  Detect  │  │  3-Fix   │       │   │ │
│  │  │   │  Guardian│      │  (Code)  │  │   Drift  │  │   Rule   │       │   │ │
│  │  │   └──────────┘      └──────────┘  └──────────┘  └──────────┘       │   │ │
│  │  └─────────────────────────────────────────────────────────────────────┘   │ │
│  │                                    │                                      │   │
│  │                                    ▼                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │ │
│  │  │                       VALIDATE (Multi-Stage)                        │   │ │
│  │  │                                                                      │   │ │
│  │  │   7a.CORRECTNESS ──► 7b.QUALITY ──► 7c.CONSISTENCY ──► 7d.ADVERSARIAL│   │ │
│  │  │        │                 │              │               │            │   │ │
│  │  │     [BLOCKING]        [BLOCKING]     [ADVISORY]      [if >= 7]      │   │ │
│  │  │                                                                      │   │ │
│  │  │   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────────┐│   │ │
│  │  │   │Syntax Check│  │ Type Check │  │  Linting   │  │ Opus + Codex   ││   │ │
│  │  │   │Pyright/Eslint││Semgrep SAST│  │Ruff/Prettier│ │ Cross-Validate ││   │ │
│  │  │   └────────────┘  └────────────┘  └────────────┘  └────────────────┘│   │ │
│  │  └─────────────────────────────────────────────────────────────────────┘   │ │
│  │                                    │                                      │   │
│  │                         ┌──────────┴──────────┐                           │ │
│  │                         │                     │                            │ │
│  │                         ▼                     ▼                            │ │
│  │                  ┌─────────────┐      ┌─────────────┐                     │ │
│  │                  │ITERATE LOOP │      │ VERIFIED_   │                     │ │
│  │                  │  (max 25)   │      │    DONE     │                     │ │
│  │                  └─────────────┘      └─────────────┘                     │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                       │                                           │
│                                       ▼                                           │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                       STOP HOOKS (Session End)                             │ │
│  │                                                                            │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────────────────┐  │ │
│  │  │stop-verification│  │ sentry-report   │  │   reflection-engine.sh    │  │ │
│  │  │      .sh        │  │      .sh        │  │       (COLD PATH)          │  │ │
│  │  └─────────────────┘  └─────────────────┘  └───────────────────────────┘  │ │
│  │                                              │                            │ │
│  │                                              ▼                            │ │
│  │  ┌───────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    REFLECTION EXECUTOR (Cold Path)                    │ │ │
│  │  │                                                                      │ │ │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────────────────┐│ │ │
│  │  │  │ Extract Episodes│  │ Detect Patterns │  │ Generate Procedural   ││ │ │
│  │  │  │  from transcript│  │  (confidence)   │  │ Rules (≥0.8)           ││ │ │
│  │  │  └────────┬────────┘  └────────┬────────┘  └───────────┬────────────┘│ │ │
│  │  │           │                    │                       │             │ │ │
│  │  │           ▼                    ▼                       ▼             │ │ │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  │ │ │
│  │  │  │              PROCEDURAL INJECTION (Future Sessions)           │  │ │ │
│  │  │  │                                                              │  │ │ │
│  │  │  │   ~/.ralph/procedural/rules.json ──► PreToolUse:Task ──►    │  │ │ │
│  │  │  │                                          Claude receives:     │  │ │ │
│  │  │  │   "Based on past experience: [learned behavior]"             │  │ │ │
│  │  │  └───────────────────────────────────────────────────────────────┘  │ │ │
│  │  └───────────────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ═══════════════════════════════════════════════════════════════════════════════
##  MEMORY ARCHITECTURE: Hot Path + Cold Path v2.49
## ═══════════════════════════════════════════════════════════════════════════════

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          MEMORY ARCHITECTURE v2.49                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                    HOT PATH (Real-time Operations)                        ║ │
│  ╠═══════════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                           ║ │
│  ║  UserPromptSubmit Hook ──► memory-write-trigger.sh                        ║ │
│  ║         │                    │                                             ║ │
│  ║         │                    ▼                                             ║ │
│  ║         │         ┌──────────────────────┐                                 ║ │
│  ║         │         │ MEMORY INTENT DETECT │  Keywords:                      ║ │
│  ║         │         │                      │  "remember", "note",            ║ │
│  ║         │         └──────────┬───────────┘  "don't forget",               ║ │
│  ║         │                    │              "keep in mind"                 ║ │
│  ║         │                    ▼                                             ║ │
│  ║         │    ┌──────────────────────────────────────────────┐              ║ │
│  ║         │    │           claude-mem MCP (Hot Path)          │              ║ │
│  ║         │    │  ┌─────────────┐  ┌─────────────┐            │              ║ │
│  ║         │    │  │   search()  │  │timeline()   │            │              ║ │
│  ║         │    │  │  (index)    │  │  (context)  │            │              ║ │
│  ║         │    │  └─────────────┘  └─────────────┘            │              ║ │
│  ║         │    │         │                 │                   │              ║ │
│  ║         │    │         ▼                 ▼                   │              ║ │
│  ║         │    │  ┌───────────────────────────────────┐        │              ║ │
│  ║         │    │  │ get_observations([ids])           │        │              ║ │
│  ║         │    │  │ • Semantic: facts, preferences     │        │              ║ │
│  ║         │    │  • Episodic: experiences, context     │        │              ║ │
│  ║         │    │  └───────────────────────────────────┘        │              ║ │
│  ║         │    │                                               │              ║ │
│  ║         │    └───────────────────────────────────────────────┘              ║ │
│  ║         │                                                            │       ║ │
│  ║         └────────────────────────────────────────────────────────────┘       ║ │
│  ║                                                                           ║ │
│  ╠═══════════════════════════════════════════════════════════════════════════╣ ║
│  ║                    COLD PATH (Background Reflection)                      ║ ║
│  ╠═══════════════════════════════════════════════════════════════════════════╣ ║
│  ║                                                                           ║ ║
│  ║  Session Ends ──► reflection-engine.sh (Stop Hook)                       ║ ║
│  ║         │                    │                                             ║ ║
│  ║         │                    ▼                                             ║ ║
│  ║         │         ┌──────────────────────┐                                 ║ ║
│  ║         │         │  REFLECTION EXECUTOR │  ~/.claude/scripts/             ║ ║
│  ║         │         │    reflection-       │  reflection-executor.py         ║ ║
│  ║         │         │    executor.py       │                                 ║ ║
│  ║         │         └──────────┬───────────┘                                  ║ ║
│  ║         │                    │                                              ║ ║
│  ║         │                    ▼                                              ║ ║
│  ║         │    ┌──────────────────────────────────────────────┐              ║ ║
│  ║         │    │              EXTRACT EPISODES                │              ║ ║
│  ║         │    │  ┌────────────────────────────────────────┐  │              ║ ║
│  ║         │    │  │ Session transcript → JSON episodes     │  │              ║ ║
│  ║         │    │  │ ~/.ralph/episodes/YYYY-MM/ep-XXX.json  │  │              ║ ║
│  ║         │    │  │ TTL: 30 days                            │  │              ║ ║
│  ║         │    │  └────────────────────────────────────────┘  │              ║ ║
│  ║         │    └──────────────────────────────────────────────┘              ║ ║
│  ║         │                                                               │   ║ ║
│  ║         └───────────────────────────────────────────────────────────────┘   ║ ║
│  ║                                                                           ║ ║
│  ║         ┌───────────────────────────────────────────────────────────────┐  ║ ║
│  ║         │                    DETECT PATTERNS                            │  ║ ║
│  ║         │  ┌─────────────────────────────────────────────────────────┐  │  ║ ║
│  ║         │  │ Cross-session pattern detection:                       │  │  ║ ║
│  ║         │  │ • SUCCESS_PATTERNS (what works)                        │  │  ║ ║
│  ║         │  │ • FAILURE_PATTERNS (what doesn't)                      │  │  ║ ║
│  ║         │  │ • OPTIMIZATION_PATTERNS (improvements)                 │  │  ║ ║
│  ║         │  │ Confidence scoring: confidence ≥ 0.8 → auto-inject     │  │  ║ ║
│  ║         │  └─────────────────────────────────────────────────────────┘  │  ║ ║
│  ║         │                                                               │   ║ ║
│  ║         └───────────────────────────────────────────────────────────────┘   ║ ║
│  ║                                                                           ║ ║
│  ║         ┌───────────────────────────────────────────────────────────────┐  ║ ║
│  ║         │                 PROCEDURAL RULES (Learned)                    │  ║ ║
│  ║         │  ┌─────────────────────────────────────────────────────────┐  │  ║ ║
│  ║         │  │ ~/.ralph/procedural/rules.json                          │  │  ║ ║
│  ║         │  │                                                         │  │  ║ ║
│  ║         │  │ {                                                       │  │  ║ ║
│  ║         │  │   "trigger": "security audit",                          │  │  ║ ║
│  ║         │  │   "behavior": "Always run semgrep before gitleaks",    │  │  ║ ║
│  ║         │  │   "confidence": 0.92,                                   │  │  ║ ║
│  ║         │  │   "source": "session-2026-01-19"                        │  │  ║ ║
│  ║         │  │ }                                                       │  │  ║ ║
│  ║         │  └─────────────────────────────────────────────────────────┘  │  ║ ║
│  ║         │                                                               │   ║ ║
│  ║         └───────────────────────────────────────────────────────────────┘   ║ ║
│  ║                                                                           ║ ║
│  ╚═══════════════════════════════════════════════════════════════════════════╝ ║
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ═══════════════════════════════════════════════════════════════════════════════
##  HOOKS REGISTRY & EVENT FLOW v2.49.1
## ═══════════════════════════════════════════════════════════════════════════════

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          HOOKS EVENT REGISTRY v2.49.1                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  SESSION START (4 hooks)                                                 │   │
│  │  ┌─────────────────┬─────────────────┬─────────────────┬─────────────┐  │   │
│  │  │session-start-   │session-start-   │auto-sync-       │session-start-│  │   │
│  │  │welcome.sh       │ledger.sh        │global.sh        │tldr.sh      │  │   │
│  │  │(5s)             │(5s)             │(10s)            │(30s)        │  │   │
│  │  └─────────────────┴─────────────────┴─────────────────┴─────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  PRE TOOL USE (5 hooks)                                                  │   │
│  │  ┌───────────────┬───────────────┬───────────────┬───────────────┐      │   │
│  │  │git-safety-    │skill-         │fast-path-     │inject-session-│      │   │
│  │  │guard.py       │validator.sh   │check.sh       │context.sh     │      │   │
│  │  │(Bash:5s)      │(Skill:10s)    │(Task:5s)      │(Task:15s)     │      │   │
│  │  └───────────────┴───────────────┴───────────────┴───────────────┘      │   │
│  │                         ┌───────────────────────────────┐                │   │
│  │                         │smart-memory-search.sh         │                │   │
│  │                         │(Task:30s) PARALLEL SEARCH     │                │   │
│  │                         └───────────────────────────────┘                │   │
│  │                         ┌───────────────────────────────┐                │   │
│  │                         │procedural-inject.sh           │                │   │
│  │                         │(Task:10s) INJECT LEARNED      │                │   │
│  │                         └───────────────────────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  POST TOOL USE (Edit/Write: 5 hooks)                                     │   │
│  │  ┌───────────────┬───────────────┬───────────────┬───────────────┐      │   │
│  │  │quality-gates- │checkpoint-    │plan-sync-     │progress-      │      │   │
│  │  │v2.sh          │auto-save.sh   │post-step.sh   │tracker.sh     │      │   │
│  │  │(300s)         │(60s)          │(30s)          │(10s)          │      │   │
│  │  └───────────────┴───────────────┴───────────────┴───────────────┘      │   │
│  │                         ┌───────────────────────────────┐                │   │
│  │                         │auto-plan-state.sh             │                │   │
│  │                         │(Write:15s) PLAN STATE         │                │   │
│  │                         └───────────────────────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  PRE COMPACT (1 hook)                                                    │   │
│  │  ┌─────────────────┐                                                     │   │
│  │  │pre-compact-     │                                                     │   │
│  │  │handoff.sh       │                                                     │   │
│  │  │(15s)            │                                                     │   │
│  │  └─────────────────┘                                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  USER PROMPT SUBMIT (4 hooks)                                            │   │
│  │  ┌───────────────┬───────────────┬───────────────┬───────────────┐      │   │
│  │  │context-       │periodic-      │prompt-        │memory-write-  │      │   │
│  │  │warning.sh     │reminder.sh    │analyzer.sh    │trigger.sh     │      │   │
│  │  │(5s)           │(5s)           │(5s)           │(5s) HOT PATH  │      │   │
│  │  └───────────────┴───────────────┴───────────────┴───────────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  STOP (3 hooks)                                                          │   │
│  │  ┌───────────────┬───────────────┬───────────────────────────────┐      │   │
│  │  │stop-          │sentry-report  │reflection-engine.sh           │      │   │
│  │  │verification   │.sh            │(30s) COLD PATH - EXTRACT      │      │   │
│  │  │.sh(10s)       │(10s)          │                               │      │   │
│  │  └───────────────┴───────────────┴───────────────────────────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  EXIT PLAN MODE (1 hook)                                                 │   │
│  │  ┌─────────────────┐                                                     │   │
│  │  │plan-analysis-   │                                                     │   │
│  │  │cleanup.sh       │                                                     │   │
│  │  │(60s)            │                                                     │   │
│  │  └─────────────────┘                                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                    TOTAL: 29 REGISTERED HOOKS (v2.49.1)                    ║ │
│  ║  + 6 UNREGISTERED (helpers): detect-environment.sh, orchestrator-helper   ║ │
│  ║                             plan-state-init.sh, quality-gates.sh          ║ │
│  ║                             sentry-check-status.sh, sentry-correlation    ║ │
│  ╚═══════════════════════════════════════════════════════════════════════════╝ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ═══════════════════════════════════════════════════════════════════════════════
##  TOOLS & INTEGRATIONS MATRIX
## ═══════════════════════════════════════════════════════════════════════════════

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         TOOLS & INTEGRATIONS MATRIX                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  MCP SERVERS (Model Context Protocol)                                    │   │
│  │  ┌───────────────┬───────────────┬───────────────┬───────────────────┐  │   │
│  │  │  claude-mem   │   context7    │   minimax     │    playwright     │  │   │
│  │  │  Semantic     │  Docs (10K+   │  Web Search   │   Browser         │  │   │
│  │  │  Memory       │  snippets)    │  (8% cost)    │   Automation      │  │   │
│  │  │  Hot Path     │  Library API  │  Image Analysis│                   │  │   │
│  │  └───────────────┴───────────────┴───────────────┴───────────────────┘  │   │
│  │  ┌───────────────┬───────────────┬───────────────────────────────────┐  │   │
│  │  │ ast-grep      │   gordon      │         nanobanana                 │  │   │
│  │  │ Structural    │   Docker      │         Image Generation           │  │   │
│  │  │ Code Search   │   Security    │         (Gemini 2.5 Flash)         │  │   │
│  │  │ 75% savings   │   + Git       │                                   │  │   │
│  │  └───────────────┴───────────────┴───────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  CLI TOOLS                                                               │   │
│  │  ┌───────────────┬───────────────┬───────────────┬───────────────────┐  │   │
│  │  │ Claude Code   │  Codex CLI    │  Gemini CLI   │    llm-tldr       │  │   │
│  │  │ (Orchestrator │  (Security    │  (Research    │    (95% token     │  │   │
│  │  │  + Hooks)     │   Audit)      │   Only)       │     savings)      │  │   │
│  │  └───────────────┴───────────────┴───────────────┴───────────────────┘  │   │
│  │  ┌───────────────┬───────────────┬───────────────────────────────────┐  │   │
│  │  │    GitHub     │   WorkTrunk   │          MiniMax MCP              │  │   │
│  │  │    CLI (gh)   │   (worktrees) │          (mmc wrapper)            │  │   │
│  │  └───────────────┴───────────────┴───────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  RALPH CLI COMMANDS (30+)                                                │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐│   │
│  │  │ orch, loop, clarify, security, security-loop, adversarial, gates    ││   │
│  │  │ bugs, review, parallel, research, library, browse, ast, tldr        ││   │
│  │  │ worktree, worktree-pr, worktree-merge, worktree-fix, worktree-close ││   │
│  │  │ ledger, handoff, compact, sync-global, sync-to-opencode, validate   ││   │
│  │  │ memory-search, fork-suggest, memory-stats, sentry-* (8 commands)    ││   │
│  │  └─────────────────────────────────────────────────────────────────────┘│   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ═══════════════════════════════════════════════════════════════════════════════
##  SECURITY HARDENING: ERR TRAP PATTERN v2.49.1
## ═══════════════════════════════════════════════════════════════════════════════

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    SECURITY: GUARANTEED JSON OUTPUT PATTERN                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ╔═══════════════════════════════════════════════════════════════════════════╗ │
│  ║                                                                             ║ ║
│  ║   INCORRECT (v2.49.0): "Garantiza JSON en cualquier error"                ║ ║
│  ║                                                                             ║ ║
│  ║   CORRECTED (v2.49.1): "Garantiza JSON cuando comando falla (exit != 0)"  ║ ║
│  ║                                                                             ║ ║
│  ╚═══════════════════════════════════════════════════════════════════════════╝ ║
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  ERR TRAP LIMITATIONS                                                    │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │                                                                         │   │
│  │  ✅ ERR trap DOES trigger on:                                           │   │
│  │     • Command failures: `false`, `exit 1`, `command not found`          │   │
│  │     • Pipeline failures with `set -o pipefail`                          │   │
│  │                                                                         │   │
│  │  ❌ ERR trap does NOT trigger on:                                       │   │
│  │     • Undefined variables (use `set -u` - causes bash error instead)    │   │
│  │     • Syntax errors (parsing fails before execution)                    │   │
│  │                                                                         │   │
│  │  For 100% guaranteed JSON: Use EXIT trap with success flag              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  V2.49.1 SECURITY FIXES APPLIED                                          │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │                                                                         │   │
│  │  HOOK                    │ FIX APPLIED                                   │   │
│  │  ────────────────────────┼────────────────────────────────────────────   │   │
│  │  reflection-engine.sh    │ ERR trap + escape_json() for SESSION_ID      │   │
│  │  memory-write-trigger.sh │ ERR trap + escape_json() for MATCHED         │   │
│  │  procedural-inject.sh    │ ERR trap for guaranteed JSON output          │   │
│  │  reflection-executor.py  │ Path validation (allowlist dirs)             │   │
│  │  memory-manager.py       │ JSON parse error handling in _load methods   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  HOOK PATTERN (v2.49.1)                                                 │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │                                                                         │   │
│  │  #!/bin/bash                                                            │   │
│  │  set -euo pipefail                                                      │   │
│  │  umask 077                                                              │   │
│  │                                                                         │   │
│  │  # Guaranteed JSON output on command failure (exit != 0)               │   │
│  │  output_json() {                                                        │   │
│  │      echo '{"decision": "continue"}'                                    │   │
│  │  }                                                                      │   │
│  │  trap 'output_json' ERR                                                 │   │
│  │                                                                         │   │
│  │  # Helper: Sanitize strings for JSON inclusion                         │   │
│  │  escape_json() {                                                        │   │
│  │      printf '%s' "$1" | tr -d '\000-\037' | sed 's/\\/\\\\/g; s/"/\\"/g'│   │
│  │  }                                                                      │   │
│  │                                                                         │   │
│  │  # Process input...                                                     │   │
│  │  INPUT=$(cat)                                                           │   │
│  │  # ... your logic here ...                                              │   │
│  │                                                                         │   │
│  │  # Output valid JSON                                                    │   │
│  │  echo '{"decision": "continue", "status": "ok"}'                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ═══════════════════════════════════════════════════════════════════════════════
##  TESTING: 83/83 TESTS PASSING v2.49.1
## ═══════════════════════════════════════════════════════════════════════════════

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         TEST SUITE SUMMARY v2.49.1                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  TEST CATEGORIES                                                        │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │                                                                         │   │
│  │  ┌─────────────────┬───────────┬───────────────────────────────────┐   │   │
│  │  │ TEST SUITE      │  TESTS    │  STATUS                           │   │   │
│  │  ├─────────────────┼───────────┼───────────────────────────────────┤   │   │
│  │  │ memory_v2_49    │    83     │  ✅ ALL PASSING                   │   │   │
│  │  │ hooks_comprehensive │  38   │  ✅ ALL PASSING                   │   │   │
│  │  │ v2_40_integration│    26    │  ✅ ALL PASSING                   │   │   │
│  │  │ v2_45_integration│    69    │  ✅ ALL PASSING                   │   │   │
│  │  │ security_scan   │    20    │  ✅ ALL PASSING                   │   │   │
│  │  └─────────────────┴───────────┴───────────────────────────────────┘   │   │
│  │                                                                         │   │
│  │  TOTAL: 236+ TESTS ✅ ALL PASSING                                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  HOOK BEHAVIORAL TESTS (38 tests in 8 categories)                       │   │
│  │  ────────────────────────────────────────────────────────────────────    │   │
│  │                                                                         │   │
│  │  Category              │ Tests │ Purpose                               │   │
│  │  ──────────────────────┼───────┼────────────────────────────────────   │   │
│  │  JSON Output           │   7   │ Always returns valid {"decision":...} │   │
│  │  Command Injection     │   4   │ Shell metacharacters blocked          │   │
│  │  Path Traversal        │   2   │ Symlinks resolved, paths validated   │   │
│  │  Race Conditions       │   4   │ umask 077, noclobber, chmod 700      │   │
│  │  Edge Cases            │   6   │ Unicode, long inputs, null bytes     │   │
│  │  Error Handling        │   3   │ Exit 0 always, stderr clean          │   │
│  │  Regressions           │   5   │ Past bugs don't return               │   │
│  │  Performance           │   3   │ Complete in <5s                      │   │
│  │  ──────────────────────┼───────┼────────────────────────────────────   │   │
│  │  TOTAL                 │  38   │                                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## ═══════════════════════════════════════════════════════════════════════════════
##  VERSION HISTORY
## ═══════════════════════════════════════════════════════════════════════════════

| Version | Date | Highlights |
|---------|------|------------|
| **v2.49.1** | 2026-01-19 | **Security Hardening Complete** |
| | | ✅ 9/9 security findings fixed (SEC-001 to SEC-006, RE-001, RE-002, MM-001) |
| | | ✅ 29/29 hooks registered and validated |
| | | ✅ ERR trap pattern corrected (accurate documentation) |
| | | ✅ 83/83 memory tests passing |
| **v2.49.0** | 2026-01-18 | **Complete Memory Architecture** |
| | | Hot Path (claude-mem), Cold Path (reflection), Procedural (learned rules) |
| **v2.48.0** | 2026-01-17 | **Security Scanning Stage 2.5** |
| | | semgrep SAST + gitleaks integration |
| **v2.47.3** | 2026-01-17 | **38 Hook Behavioral Tests** |
| **v2.46.1** | 2026-01-18 | **RLM-Inspired** (arXiv:2512.24601v1) |

---

*Generated: 2026-01-19*
*Project: multi-agent-ralph-loop*
*License: BSL 1.1*
