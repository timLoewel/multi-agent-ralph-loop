#!/usr/bin/env bash
# mmc - MiniMax Claude Code Wrapper
# Runs Claude Code with MiniMax M2.1 backend (~8% cost)
# Based on: https://blog.devgenius.io/claude-code-but-cheaper-and-snappy-minimax-m2-1-with-a-tiny-wrapper-7d910db93383

set -euo pipefail

VERSION="2.14.0"
CONFIG_FILE="${HOME}/.ralph/config/minimax.json"
RALPH_DIR="${HOME}/.ralph"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
mmc - MiniMax Claude Code Wrapper v2.14.0

Run Claude Code with MiniMax M2.1 backend (~8% of Claude's cost).

USAGE:
  mmc                     Launch Claude Code with MiniMax backend
  mmc --setup             Configure MiniMax API key
  mmc --query "prompt"    Single query to MiniMax
  mmc --loop N "task"     Loop up to N iterations (default: 30)
  mmc --lightning         Use MiniMax-lightning model (faster, 60 iter)
  mmc --second-opinion    Get second opinion on previous result
  mmc --status            Show configuration status
  mmc --stats             Show usage statistics from logs
  mmc --version           Show version
  mmc --help              Show this help

MODEL MAPPING:
  Claude Slot          -> MiniMax Model
  ------------------------------------------------
  ANTHROPIC_SMALL_FAST -> MiniMax-M2.1-lightning
  ANTHROPIC_MODEL      -> MiniMax-M2.1
  (Haiku tasks)        -> MiniMax-M2.1-lightning
  (Sonnet/Opus tasks)  -> MiniMax-M2.1

ITERATION LIMITS:
  MiniMax M2.1:         30 iterations (2x Claude)
  MiniMax-lightning:    60 iterations (4x Claude)

COST COMPARISON:
  Model             Input/M    Output/M    vs Claude
  ------------------------------------------------
  Claude Sonnet     $3.00      $15.00      baseline
  MiniMax M2.1      $0.30      $1.20       ~8%
  MiniMax-lightning $0.15      $0.60       ~4%

EXAMPLES:
  mmc                           # Launch Claude Code with MiniMax
  mmc --setup                   # First time setup
  mmc --query "Review this code"
  mmc --loop 30 "Fix all bugs"
  mmc --lightning --loop 60 "Extended task"
EOF
}

ensure_dirs() {
    mkdir -p "${RALPH_DIR}/config"
    mkdir -p "${RALPH_DIR}/logs"
}

setup() {
    ensure_dirs

    echo -e "${BLUE}MiniMax Configuration${NC}"
    echo ""

    # ISSUE-004: Hide API key input with -s flag
    read -s -p "Enter your MiniMax API key: " API_KEY
    echo ""  # New line after hidden input

    if [ -z "$API_KEY" ]; then
        echo -e "${RED}Error: API key cannot be empty${NC}"
        exit 1
    fi

    cat > "$CONFIG_FILE" << JSONEOF
{
  "apiKey": "$API_KEY",
  "baseUrl": "https://api.minimax.io/anthropic",
  "defaultModel": "MiniMax-M2.1",
  "lightningModel": "MiniMax-M2.1-lightning",
  "modelMapping": {
    "claude-3-5-haiku-latest": "MiniMax-M2.1-lightning",
    "claude-sonnet-4-20250514": "MiniMax-M2.1",
    "claude-opus-4-20250514": "MiniMax-M2.1"
  }
}
JSONEOF

    chmod 600 "$CONFIG_FILE"
    echo -e "${GREEN}Configuration saved to: $CONFIG_FILE${NC}"

    # Migrate old config if exists
    if [ -f "$HOME/.mmc.json" ]; then
        echo -e "${YELLOW}Note: Old config found at ~/.mmc.json - you can remove it${NC}"
    fi
}

check_config() {
    # Check new location first, fall back to old
    if [ ! -f "$CONFIG_FILE" ]; then
        # Try old location
        if [ -f "$HOME/.mmc.json" ]; then
            CONFIG_FILE="$HOME/.mmc.json"
            echo -e "${YELLOW}Using legacy config: ~/.mmc.json${NC}"
            echo -e "${YELLOW}Run 'mmc --setup' to migrate to new location${NC}"
        else
            echo -e "${RED}Error: MiniMax not configured. Run: mmc --setup${NC}"
            exit 1
        fi
    fi
}

check_dependencies() {
    local MISSING=()

    command -v jq &>/dev/null || MISSING+=("jq")
    command -v curl &>/dev/null || MISSING+=("curl")
    command -v claude &>/dev/null || MISSING+=("claude")

    if [ ${#MISSING[@]} -gt 0 ]; then
        echo -e "${RED}Error: Missing dependencies: ${MISSING[*]}${NC}"
        echo "Install with:"
        echo "  brew install ${MISSING[*]}"
        exit 1
    fi
}

get_api_key() {
    # Support environment variable override (more secure)
    if [ -n "${MINIMAX_API_KEY:-}" ]; then
        echo "$MINIMAX_API_KEY"
    else
        jq -r '.apiKey' "$CONFIG_FILE"
    fi
}

get_base_url() {
    jq -r '.baseUrl' "$CONFIG_FILE"
}

log_usage() {
    local ACTION="$1"
    local MODEL="$2"
    local CHARS="${3:-0}"
    local LOG_FILE="${RALPH_DIR}/logs/usage.jsonl"
    mkdir -p "$(dirname "$LOG_FILE")"
    echo "{\"ts\":$(date +%s),\"action\":\"$ACTION\",\"model\":\"$MODEL\",\"chars\":$CHARS}" >> "$LOG_FILE"
}

show_status() {
    echo -e "${BLUE}MiniMax Configuration Status${NC}"
    echo ""

    if [ -f "$CONFIG_FILE" ]; then
        echo -e "Config file: ${GREEN}$CONFIG_FILE${NC}"
        echo -e "Base URL:    $(jq -r '.baseUrl' "$CONFIG_FILE")"
        echo -e "Model:       $(jq -r '.defaultModel' "$CONFIG_FILE")"
        echo -e "Lightning:   $(jq -r '.lightningModel' "$CONFIG_FILE")"

        # Test connection
        echo ""
        echo -n "API Status:  "
        local API_KEY=$(get_api_key)
        local BASE_URL=$(get_base_url)

        if curl -s --max-time 5 "${BASE_URL}/v1/models" \
            -H "Authorization: Bearer $API_KEY" | grep -q "model"; then
            echo -e "${GREEN}Connected${NC}"
        else
            echo -e "${YELLOW}Unable to verify (check API key)${NC}"
        fi
    else
        echo -e "Config file: ${RED}Not found${NC}"
        echo ""
        echo "Run 'mmc --setup' to configure"
    fi
}

query() {
    local PROMPT="$1"
    local MODEL="${2:-MiniMax-M2.1}"

    log_usage "query" "$MODEL" "${#PROMPT}"

    check_config
    check_dependencies

    local API_KEY=$(get_api_key)
    local BASE_URL=$(get_base_url)

    # SECURITY: Properly escape prompt to prevent JSON injection
    local ESCAPED_PROMPT
    ESCAPED_PROMPT=$(printf '%s' "$PROMPT" | jq -Rs '.')

    curl -s "${BASE_URL}/v1/messages" \
        -H "Authorization: Bearer $API_KEY" \
        -H "Content-Type: application/json" \
        -H "anthropic-version: 2023-06-01" \
        -d "{
            \"model\": \"$MODEL\",
            \"max_tokens\": 4096,
            \"messages\": [{\"role\": \"user\", \"content\": $ESCAPED_PROMPT}]
        }" | jq -r '.content[0].text // .error.message // "Error"'
}

launch_claude_code() {
    check_config
    check_dependencies

    local API_KEY=$(get_api_key)
    local BASE_URL=$(get_base_url)
    local USE_LIGHTNING="${1:-false}"
    shift || true

    local MODEL="MiniMax-M2.1"
    local SMALL_MODEL="MiniMax-M2.1-lightning"

    if [ "$USE_LIGHTNING" = "true" ]; then
        MODEL="MiniMax-M2.1-lightning"
    fi

    log_usage "chat" "$MODEL" "0"

    echo -e "${BLUE}Launching Claude Code with MiniMax backend${NC}"
    echo -e "   Model: ${GREEN}$MODEL${NC}"
    echo -e "   Small/Fast: ${GREEN}$SMALL_MODEL${NC}"
    echo ""

    ANTHROPIC_API_KEY="$API_KEY" \
    ANTHROPIC_BASE_URL="$BASE_URL" \
    ANTHROPIC_MODEL="$MODEL" \
    ANTHROPIC_SMALL_FAST_MODEL="$SMALL_MODEL" \
    claude "$@"
}

loop() {
    local MAX_ITER="${1:-30}"
    shift
    local TASK="$*"

    log_usage "loop" "MiniMax-M2.1" "${#TASK}"

    check_config
    check_dependencies

    echo -e "${BLUE}Starting loop: $MAX_ITER iterations max${NC}"
    echo -e "   Task: $TASK"
    echo ""

    local ITER=0
    while [ $ITER -lt $MAX_ITER ]; do
        ((ITER++))
        echo -e "${YELLOW}[Iteration $ITER/$MAX_ITER]${NC}"

        RESULT=$(query "$TASK. If complete, respond with VERIFIED_DONE.")
        echo "$RESULT"
        echo ""

        if echo "$RESULT" | grep -q "VERIFIED_DONE"; then
            echo -e "${GREEN}Task completed at iteration $ITER${NC}"
            return 0
        fi
    done

    echo -e "${YELLOW}Max iterations reached without VERIFIED_DONE${NC}"
    return 1
}

cmd_stats() {
    local LOG_FILE="${RALPH_DIR}/logs/usage.jsonl"
    if [[ ! -f "$LOG_FILE" ]]; then
        echo "No usage logs found"
        return 0
    fi
    echo "=== MiniMax Usage Stats ==="
    echo "Total queries: $(wc -l < "$LOG_FILE" | tr -d ' ')"
    echo ""
    echo "By action:"
    jq -r '.action' "$LOG_FILE" 2>/dev/null | sort | uniq -c | sed 's/^/  /' || echo "  (install jq for detailed stats)"
    echo ""
    echo "By model:"
    jq -r '.model' "$LOG_FILE" 2>/dev/null | sort | uniq -c | sed 's/^/  /' || echo "  (install jq for detailed stats)"
    echo ""
    echo "Total chars processed: $(jq -s '[.[].chars] | add' "$LOG_FILE" 2>/dev/null || echo "N/A")"
}

main() {
    local CMD="${1:-launch}"

    case "$CMD" in
        --setup|setup)
            setup
            ;;
        --query|-q)
            shift
            query "$*"
            ;;
        --loop|-l)
            shift
            loop "$@"
            ;;
        --lightning)
            shift
            if [ "${1:-}" = "--loop" ]; then
                shift
                local MAX="${1:-60}"
                shift
                echo -e "${BLUE}Using MiniMax-lightning (60 iter max)${NC}"
                loop "$MAX" "$@"
            else
                launch_claude_code true "$@"
            fi
            ;;
        --second-opinion)
            shift
            query "As a second opinion, review this: $*"
            ;;
        --status)
            show_status
            ;;
        --stats)
            cmd_stats
            ;;
        --version|-v)
            echo "mmc v$VERSION"
            ;;
        --help|-h)
            show_help
            ;;
        launch|"")
            shift 2>/dev/null || true
            launch_claude_code false "$@"
            ;;
        *)
            # Pass through to claude code with MiniMax
            launch_claude_code false "$@"
            ;;
    esac
}

main "$@"
