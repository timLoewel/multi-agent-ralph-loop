# Retrospective: Curator v2.55.0 Critical Fixes

**Date**: 2026-01-20
**Version**: v2.55.0
**Severity**: CRITICAL
**Status**: RESOLVED

---

## Executive Summary

Durante la implementación del Context Relevance Scoring para el sistema Repo Curator, se descubrieron y corrigieron múltiples errores críticos en los scripts bash y hooks de Claude Code. Este documento detalla cada problema, su causa raíz, y las correcciones aplicadas para prevenir futuras ocurrencias.

---

## Problemas Identificados

### 1. CRIT-001: Arithmetic Bug con `((var++))` y `set -e`

**Archivos afectados**:
- `curator-approve.sh`
- `curator-learn.sh`

**Síntoma**: Los scripts terminaban prematuramente sin mensaje de error.

**Causa raíz**: Con `set -e` (exit on error), la expresión `((count++))` retorna exit code 1 cuando `count=0` porque el resultado de la expresión (0) se interpreta como `false` en bash.

```bash
# INCORRECTO - falla cuando count=0
set -e
count=0
((count++))  # Exit code 1! Script termina

# CORRECTO
count=$((count + 1))  # Siempre exit code 0
```

**Fix aplicado**: Reemplazado todas las instancias de `((var++))` con `var=$((var + 1))`.

---

### 2. CRIT-002: POSIX Compatibility con `read -ra`

**Archivo afectado**: `curator-scoring.sh`

**Síntoma**: Context relevance scoring siempre retornaba -1 para todos los repos.

**Causa raíz**: La sintaxis `read -ra array <<< "$string"` es un bashism que falla silenciosamente en zsh (el shell del usuario).

```bash
# INCORRECTO - no funciona en zsh
IFS=',' read -ra keywords <<< "$context_keywords"

# CORRECTO - POSIX compatible
local OLD_IFS="$IFS"
IFS=','
for keyword in $context_keywords; do
    # process keyword
done
IFS="$OLD_IFS"
```

**Fix aplicado**: Reemplazado con iteración POSIX-compatible usando `for` loop.

---

### 3. CRIT-003: Variable `description` No Inicializada

**Archivo afectado**: `curator-scoring.sh`

**Síntoma**: El scoring de descripción siempre era 0.

**Causa raíz**: La variable `description` estaba declarada pero nunca se asignaba valor antes de usarla.

```bash
# INCORRECTO - variable vacía
local description
desc_length=$(echo "$description" | wc -c)  # Siempre 1

# CORRECTO
description=$(echo "$repo_json" | jq -r '.description // ""')
desc_length=$(echo "$description" | wc -c)
```

**Fix aplicado**: Añadida extracción de descripción desde JSON.

---

### 4. CRIT-004: Composite Score No Aplicado en Ranking

**Archivo afectado**: `curator-rank.sh`

**Síntoma**: Repos con alto relevance score no subían en el ranking.

**Causa raíz**: El ranking solo ordenaba por `quality_score`, ignorando `context_relevance_score`.

**Fix aplicado**: Implementada fórmula de composite score:

```bash
# Composite score = quality * (1 + max(0, relevance * 0.1))
jq '[.[] | . + {
    _composite_score: (
        (.quality_metrics.quality_score // 0) *
        (1 + ([0, ((.quality_metrics.context_relevance_score // 0) * 0.1)] | max))
    )
}] | sort_by(._composite_score) | reverse'
```

---

### 5. CRIT-005: PreToolUse Hook con Formato JSON Incorrecto

**Archivo afectado**: `procedural-inject.sh`

**Síntoma**: Error "PreToolUse:Task hook error" aparecía intermitentemente.

**Causa raíz**: El hook usaba `{"decision": "approve"}` que es formato de **Stop hooks**, no PreToolUse.

```bash
# INCORRECTO - formato de Stop hooks
echo '{"decision": "approve"}'

# CORRECTO - PreToolUse debe exit silencioso
exit 0
```

**Fix aplicado**: Cambiado a `exit 0` y corregidos comentarios engañosos.

---

### 6. CRIT-006: Múltiples Problemas de Security/Quality

**Identificados por Code Review Agent** (53 issues total):

| Categoría | Crítico | Alto | Medio | Bajo |
|-----------|---------|------|-------|------|
| Command Injection | 2 | 1 | - | - |
| Error Handling | 1 | 3 | 5 | - |
| Race Conditions | - | 3 | 2 | - |
| Input Validation | 1 | 2 | 3 | - |
| Other | 2 | 9 | 7 | 12 |

**Issues críticos pendientes**:
1. Command injection via `$query` en curator-discovery.sh:249
2. Variables no sanitizadas en `bc` (curator-scoring.sh)
3. Grep regex injection en curator-approve.sh:96

---

## Claude Code Hook Formats Reference

Para evitar futuros errores, aquí está la referencia oficial de formatos:

### PreToolUse Hooks

```bash
# Permitir herramienta (silencioso)
exit 0

# Bloquear herramienta
echo '{"blockReason": "Reason here"}' >&2
exit 2
```

### PostToolUse Hooks

```bash
# Permitir continuar
echo '{"continue": true}'

# Permitir con mensaje
echo '{"continue": true, "systemMessage": "Info here"}'
```

### UserPromptSubmit Hooks

```bash
# Permitir prompt
echo '{"continue": true}'

# Permitir con contexto adicional
echo '{"continue": true, "systemMessage": "Context here"}'
```

### Stop Hooks

```bash
# Aprobar parada
echo '{"decision": "approve"}'

# Bloquear parada (continuar sesión)
echo '{"decision": "block", "reason": "Not finished"}'
```

---

## Root Cause Analysis: ¿Por qué Claude Falló?

### Problema de Documentación

1. **Documentación contradictoria**: Algunos hooks tenían comentarios incorrectos sobre el formato esperado
2. **Copypaste entre hooks**: Errores se propagaron al copiar código entre diferentes tipos de hooks
3. **Falta de validación**: No existía un script de validación de formatos de hooks

### Problema de Testing

1. **No había tests automatizados** para los scripts de curator
2. **No se verificaba** la compatibilidad POSIX
3. **Los hooks no tenían** tests unitarios

### Problema de Observability

1. **`2>/dev/null || true`** oculta errores críticos
2. **Exit codes no verificados** después de comandos
3. **Logs insuficientes** para debugging

---

## Acciones Preventivas

### Corto Plazo (Inmediato)

- [x] Fix CRIT-001: `((var++))` → `var=$((var + 1))`
- [x] Fix CRIT-002: `read -ra` → POSIX for loop
- [x] Fix CRIT-003: Inicializar `description`
- [x] Fix CRIT-004: Composite score en ranking
- [x] Fix CRIT-005: PreToolUse format → `exit 0`

### Mediano Plazo (Esta Semana) - ✅ COMPLETADO

- [x] Fix command injection issues (CRITICAL) - SEC-007, SEC-008, SEC-010
- [x] Agregar input validation a todos los scripts - `validate_input()` en discovery, learn
- [x] Implementar `mktemp` en lugar de `$$` para temp files - discovery, rank, ingest, learn
- [ ] Agregar ShellCheck a CI/CD

### CRIT-006: Security Issues - FIXES APLICADOS

| Script | Issue | Fix Applied |
|--------|-------|-------------|
| `curator-approve.sh` | grep regex injection | `grep -Fxl` (SEC-007) |
| `curator-approve.sh` | Path traversal risk | Path validation before rm -rf (SEC-007) |
| `curator-scoring.sh` | bc code injection | Numeric validation (SEC-008) |
| `curator-scoring.sh` | grep regex injection | `grep -Fqi` (SEC-008) |
| `curator-discovery.sh` | Predictable temp files | `mktemp` (SEC-009) |
| `curator-discovery.sh` | No input validation | `validate_input()` (SEC-010) |
| `curator-rank.sh` | Predictable temp files | `mktemp` (SEC-009) |
| `curator-rank.sh` | No numeric validation | Regex check for TOP_N, MAX_PER_ORG |
| `curator-ingest.sh` | Predictable temp dirs | `mktemp -d` (SEC-009) |
| `curator-ingest.sh` | CRIT-001 ((var++)) | `var=$((var + 1))` |
| `curator-ingest.sh` | Syntax error L179 | Fixed broken heredoc |
| `curator-learn.sh` | Predictable temp files | `mktemp` (SEC-009) |
| `curator-learn.sh` | No input validation | `validate_input()` (SEC-010) |
| `curator-queue.sh` | CRIT-001 ((count++)) | `count=$((count + 1))` |
| `curator-queue.sh` | Dead code temp file | Removed unused variable |
| `procedural-inject.sh` | Wrong JSON format | `exit 0` (CRIT-005) |
| `agent-memory-auto-init.sh` | Misleading comment | Corrected docs |

### Largo Plazo (Este Mes)

- [ ] Crear test suite para curator scripts
- [ ] Documentar formatos de hooks en CLAUDE.md
- [ ] Implementar hook validator script
- [ ] Agregar observability con logs estructurados

---

## Verificación

### Test Suite Ejecutada

```bash
# Test 1: Pipeline completo
curator.sh --type backend --lang typescript --top-n 5 \
    --context "resilience,retry,circuit-breaker"
# RESULTADO: ✅ Completado en 15s

# Test 2: Context relevance scoring
# cockatiel (resilience library): relevance=5 ✅
# otros repos: relevance=-1 ✅

# Test 3: Composite ranking
# cockatiel en posición #1 a pesar de tener menos stars ✅

# Test 4: Security verification
grep -rn '\$\$' curator-*.sh | grep -v "SEC-009"
# RESULTADO: ✅ No $$ patterns found

grep -rn '(([a-z_]*++))' curator-*.sh
# RESULTADO: ✅ No ((var++)) patterns found

grep -l "validate_input" curator-*.sh
# RESULTADO: ✅ curator-discovery.sh, curator-learn.sh

grep -l "mktemp" curator-*.sh
# RESULTADO: ✅ discovery, rank, ingest, learn (4 scripts)
```

### Verificación de Hooks

```bash
# Verificar que procedural-inject.sh usa exit 0
tail -5 ~/.claude/hooks/procedural-inject.sh | grep "exit 0"
# RESULTADO: ✅ exit 0 (not JSON output)

# Verificar que agent-memory-auto-init.sh tiene comentario correcto
grep "NOT.*decision.*approve" ~/.claude/hooks/agent-memory-auto-init.sh
# RESULTADO: ✅ Comment clarifies NOT to use JSON
```

---

## Lecciones Aprendidas

### Aritmética en Bash
1. **Siempre usar `var=$((var + 1))`** en lugar de `((var++))` con `set -e`
   - `((expr))` retorna exit code basado en el valor, no en el éxito

### Portabilidad
2. **Evitar bashisms** como `read -ra` cuando se espera compatibilidad cross-shell
3. **Usar `mktemp`** en lugar de `$$` para archivos temporales seguros

### Hook Formats (CRÍTICO)
4. **Los formatos de hooks son específicos por tipo**:
   - PreToolUse: `exit 0` (silencioso) o `exit 2` con JSON en stderr
   - PostToolUse: `{"continue": true/false}`
   - UserPromptSubmit: `{"continue": true/false}`
   - Stop: `{"decision": "approve/block"}`

### Seguridad
5. **Siempre usar `grep -F`** cuando se busca texto literal (no regex)
6. **Validar todos los inputs** antes de usarlos en comandos
7. **Validar paths** antes de `rm -rf`
8. **Validar números** antes de pasarlos a `bc`

### Observabilidad
9. **No usar `2>/dev/null || true`** en producción - oculta errores críticos
10. **Exit codes verificados** después de comandos importantes

### Documentación
11. **Documentar formatos esperados** en cada hook con referencia a docs oficiales
12. **Mantener comentarios sincronizados** con el código

---

## Referencias

- [Claude Code Hooks Documentation](https://docs.anthropic.com/claude-code/hooks)
- [Bash Pitfalls](https://mywiki.wooledge.org/BashPitfalls)
- [POSIX Shell Guide](https://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html)
- Code Review Report: Agent a3f60da
- Security Audit Report: Agent a6343e2

---

*Generated by Multi-Agent Ralph Loop v2.55.0*
